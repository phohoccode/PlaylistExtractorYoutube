<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Youtube Playlist Embed</title>
    <!-- Thêm Bootstrap CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding: 30px;
      }

      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .video-box {
        margin-top: 30px;
        max-height: 350px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        padding: 15px;
        background-color: #f9fafb;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
      }

      .video-item {
        background-color: #e9f5e9;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        font-size: 14px;
        text-align: left;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
        cursor: pointer;
      }

      .video-item:hover {
        background-color: #d0f0d0;
      }

      .history-box {
        margin-top: 20px;
        padding: 10px;
        background-color: #f1f1f1;
        border-radius: 8px;
      }

      .history-item {
        padding: 8px;
        margin-bottom: 8px;
        background-color: #fff;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .history-item:hover {
        background-color: #e0f7fa;
      }

      .copy-all-button {
        background-color: #2196f3;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }

      .copy-all-button:hover {
        background-color: #1e88e5;
      }

      .copy-all-button:active {
        background-color: #1c7cc1;
      }

      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2 class="text-center mb-4">Nhập ID danh sách phát YouTube</h2>

      <!-- Input và Button -->
      <div class="input-group mb-3">
        <input
          type="text"
          id="playlistId"
          class="form-control"
          placeholder="VD: PL_-VfJajZj0Uo72G_6tSY4NRLpmffeXSA"
        />
        <button class="btn btn-success" onclick="loadVideos()">
          Tải Video
        </button>
      </div>

      <!-- Video Box -->
      <div class="video-box" id="videoBox"></div>

      <div class="d-flex gap-4 mt-3">
        <button
          class="copy-all-button btn btn-primary w-30"
          onclick="copyAllLinks()"
        >
          Sao chép tất cả liên kết
        </button>
        <button class="btn btn-warning w-30" onclick="refreshVideos()">
          Làm mới
        </button>
        <button class="btn btn-danger w-30" onclick="resetData()">
          Xóa dữ liệu
        </button>
      </div>

      <!-- Lịch sử -->
      <div class="history-box mt-4" id="historySection">
        <div class="d-flex gap-3 justify-content-between align-items-center mb-4">
          <h3>Lịch sử</h3>
          <button class="btn btn-danger w-30" onclick="clearHistory()">
            Xóa lịch sử
          </button>
        </div>
        <div id="historyList"></div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container">
      <div
        id="toast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto">Thông báo</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
      </div>
    </div>

    <!-- Thêm Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let nextPageToken = null;
      let videoLinks = [];
      let history = JSON.parse(localStorage.getItem("history")) || [];

      // Hiển thị lịch sử ID danh sách phát
      function displayHistory() {
        const historySection = document.getElementById("historySection");
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = ""; // Xóa danh sách hiện tại

        if (history.length === 0) {
          historySection.style.display = "none"; // Ẩn phần lịch sử nếu không có dữ liệu
        } else {
          historySection.style.display = "block"; // Hiển thị phần lịch sử nếu có dữ liệu
          history.forEach((id) => {
            const historyItem = document.createElement("div");
            historyItem.className = "history-item";
            historyItem.innerText = id;
            historyItem.onclick = () => {
              document.getElementById("playlistId").value = id;
              loadVideos(); // Tải lại video với ID này
            };
            historyList.appendChild(historyItem);
          });
        }
      }

      // Hiển thị thông báo Toast
      function showToast(message) {
        const toastBody = document.getElementById("toastBody");
        toastBody.innerText = message;
        const toast = new bootstrap.Toast(document.getElementById("toast"));
        toast.show();
      }

      async function loadVideos() {
        const playlistId = document.getElementById("playlistId").value.trim();
        if (!playlistId) {
          showToast("Vui lòng nhập ID danh sách phát");
          return;
        }

        // Lưu vào lịch sử nếu chưa có
        if (!history.includes(playlistId)) {
          history.push(playlistId);
          localStorage.setItem("history", JSON.stringify(history));
        }

        const apiKey = "AIzaSyAtRnOZWPF_SwCctliSo6eT6TLeZOOHNcw";
        const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&key=${apiKey}&maxResults=50${
          nextPageToken ? `&pageToken=${nextPageToken}` : ""
        }`;

        try {
          const response = await fetch(url);
          const data = await response.json();

          if (data.items) {
            const videoBox = document.getElementById("videoBox");
            videoBox.innerHTML = ""; // Reset video box

            data.items.forEach((item) => {
              const videoId = item.snippet.resourceId.videoId;
              const videoUrl = `https://www.youtube.com/embed/${videoId}`;
              const videoElement = document.createElement("div");
              videoElement.className = "video-item";
              videoElement.innerText = videoUrl;
              videoElement.onclick = () => copyLink(videoUrl); // Thêm sự kiện sao chép khi nhấn vào video
              videoBox.appendChild(videoElement);

              // Lưu video URL vào mảng
              videoLinks.push(videoUrl);
            });
          }

          // Nếu có nextPageToken, cập nhật để tải thêm video
          nextPageToken = data.nextPageToken || null;
          if (nextPageToken) {
            loadVideos(); // Tải thêm video nếu có nextPageToken
          } else {
            showToast("Đã tải hết video.");
          }
        } catch (error) {
          showToast("Có lỗi xảy ra. Vui lòng thử lại!");
        }

        displayHistory(); // Cập nhật lại danh sách lịch sử
      }

      // Sao chép tất cả liên kết
      function copyAllLinks() {
        const text = videoLinks.join("\n"); // Nối tất cả các video URL lại với nhau
        const tempInput = document.createElement("textarea");
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        showToast("Đã sao chép tất cả liên kết!");
      }

      // Hàm sao chép liên kết của video cụ thể khi người dùng nhấn vào
      function copyLink(url) {
        const tempInput = document.createElement("textarea");
        tempInput.value = url;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        showToast("Đã sao chép liên kết video!");
      }

      // Làm mới dữ liệu
      function refreshVideos() {
        // Xóa các video đã tải
        document.getElementById("videoBox").innerHTML = "";
        videoLinks = [];
        nextPageToken = null;

        // Lấy lại video với ID playlist hiện tại
        loadVideos();
      }

      // Reset dữ liệu
      function resetData() {
        // Xóa text trong input
        document.getElementById("playlistId").value = "";

        // Xóa các liên kết embed video
        document.getElementById("videoBox").innerHTML = "";

        // Reset mảng videoLinks và nextPageToken
        videoLinks = [];
        nextPageToken = null;

        showToast("Dữ liệu đã được làm mới!");
      }

      // Xóa lịch sử
      function clearHistory() {
        history = [];
        localStorage.setItem("history", JSON.stringify(history));
        displayHistory();
        showToast("Đã xóa lịch sử.");
      }

      // Hiển thị lịch sử ngay khi tải trang
      displayHistory();
    </script>
  </body>
</html>
